# vim: foldmethod=marker foldlevel=0

### general settings
# {{{

set -g default-terminal 'tmux-256color'
set -g history-limit 10000
set -g escape-time 0
set -g base-index 1
set -g renumber-windows on
set -g focus-events on
set -g allow-rename on

set -g pane-base-index 1
set -g pane-border-style bg=default,fg=colour236
set -g pane-active-border-style bg=default,fg=colour240
set -g monitor-activity on
set -g activity-action none
set -g other-pane-height 25
set -g other-pane-width 80

# enable TrueColor
set -sa terminal-overrides ',xterm*:Tc'

# disable italics
# set -sa terminal-overrides ',*:sitm@,ritm@'

# desktop integration
set -g set-titles on
set -g set-titles-string '#{pane_current_command}: #{pane_title}'
set -g set-clipboard on

# mouse support
set -g mouse on

bind -T root WheelUpPane   select-pane -t= \; if -F -t= '#{mouse_any_flag}' 'send -M' 'if -Ft= "#{pane_in_mode}" "send -M" "copy-mode -e"'
bind -T root WheelDownPane select-pane -t= \; send -M

bind -T root M-WheelUpPane select-pane -t= \; if -F -t= '#{mouse_any_flag}' 'send -M' 'if -Ft= "#{pane_in_mode}" "send -M" "copy-mode -e"'
bind -T copy-mode-vi M-WheelUpPane   send -X halfpage-up
bind -T copy-mode-vi M-WheelDownPane send -X halfpage-down

# }}}

### keybindings
# {{{

set -g status-keys emacs
set -g mode-keys vi

# use C-` as the prefix key
unbind C-b
set -g prefix C-@
bind ` send-prefix
if '[ -n "$SSH_CONNECTION" -o -n "$CYGWIN" ]' 'set -g prefix2 C-g'
if '[ -n "$SSH_CONNECTION" -o -n "$CYGWIN" ]' 'bind g send-prefix -2'

# align windows vertically
bind = select-layout even-vertical

# reload the tmux configuration
bind R source-file ~/.tmux.conf

# zoom current pane
bind -T root M-\\ resize-pane -Z

# switch between panes
tmux_select="~/bin/tmux-select"

bind                   h run 'tmux select-pane -L || true'
bind                 C-h run 'tmux select-pane -L || true'
bind -T copy-mode-vi C-h run 'tmux select-pane -L || true'
bind -T root         C-h run '$tmux_select -L || true'

bind                   j run 'tmux select-pane -D || true'
bind                 C-j run 'tmux select-pane -D || true'
bind -T copy-mode-vi C-j run 'tmux select-pane -D || true'
bind -T root         C-j run '$tmux_select -D || true'

bind                   k run 'tmux select-pane -U || true'
bind                 C-k run 'tmux select-pane -U || true'
bind -T copy-mode-vi C-k run 'tmux select-pane -U || true'
bind -T root         C-k run '$tmux_select -U || true'

bind                   l run 'tmux select-pane -R || true'
bind                 C-l run 'tmux select-pane -R || true'
bind -T copy-mode-vi C-l run 'tmux select-pane -R || true'
bind -T root         C-l run '$tmux_select -R || true'

bind                   \\ run '$tmux_select --last || true'
bind                 C-\\ run '$tmux_select --last || true'
bind -T copy-mode-vi C-\\ run '$tmux_select --last || true'
bind -T root         C-\\ run '$tmux_select --last || true'

# resize panes
bind -r   H resize-pane -L 3
bind -r C-H resize-pane -L 3
bind -r   J resize-pane -D 3
bind -r C-J resize-pane -D 3
bind -r   K resize-pane -U 3
bind -r C-K resize-pane -U 3
bind -r   L resize-pane -R 3
bind -r C-L resize-pane -R 3

# switch between windows
bind Space next-window
bind -T root M-[ previous-window
bind -T root M-] next-window

# swap windows
bind -r < swap-window -t -1
bind -r > swap-window -t +1

# copy mode bindings
bind                 [          copy-mode -e
bind                 C-[        copy-mode -e
bind -T root         S-PageUp   copy-mode -eu
bind -T root         S-PageDown send
bind -T copy-mode-vi S-PageUp   send -X page-up
bind -T copy-mode-vi S-PageDown send -X page-down

bind -T copy-mode-vi Home send -X start-of-line
bind -T copy-mode-vi End  send -X end-of-line
bind -T copy-mode-vi ]    send -X cancel
bind -T copy-mode-vi v    send -X begin-selection
unbind -T copy-mode-vi    C-j

# open new windows/panes in current directory (also requires PROMPT_COMMAND)
bind c   new-window
bind C-c new-window
bind C   run '~/bin/mux'

bind s   run '~/bin/mux -s'
bind C-s run '~/bin/mux -s'
bind v   run '~/bin/mux -v'
bind C-v run '~/bin/mux -v'

bind b   run '~/bin/mux -b'
bind C-b run '~/bin/mux -b'
bind r   run '~/bin/mux -r'
bind C-r run '~/bin/mux -r'

bind S run 'tmux set-option -w synchronize-panes; tmux show-options -w synchronize-panes | fgrep -q off && tmux display "Pane synchronization disabled" || tmux display "Pane synchronization enabled"'

# }}}

### plugins

run ~/.tmux/yank/yank.tmux
run ~/.tmux/open/open.tmux

## copycat
# {{{

  run ~/.tmux/copycat/copycat.tmux
  unbind -T prefix C-d
  unbind -T prefix C-f
  unbind -T prefix C-g
  unbind -T prefix C-u
  unbind -T prefix M-h
  unbind -T prefix M-i

  copycat_search='~/.tmux/copycat/scripts/copycat_search.sh'
  copycat_start='~/.tmux/copycat/scripts/copycat_mode_start.sh'
  copycat_jump='~/.tmux/copycat/scripts/copycat_jump.sh'
  copycat_git='~/.tmux/copycat/scripts/copycat_git_special.sh'

  # freeform search
  bind -T root M-/ run '$tmux_select -c bash $copycat_search || tmux send-keys M-/'

  # paths
  set -g @copycat_custom_search_paths '(\.?/|\b[^:[:space:]]+?/)[^:[:space:]]+?(:[0-9]+)?\b'
  bind -T root M-p run '$tmux_select -c bash $copycat_start "$( tmux show-options -gv @copycat_custom_search_paths )" || tmux send-keys M-p'

  # git status
  bind -T root M-P run '$tmux_select -c bash $copycat_git "#{pane_current_path}" || tmux send-keys M-g'

  # lines
  bind -T root M-l run '$tmux_select -c bash $copycat_start "^$USER.*|.*" && $tmux_select -c bash $copycat_jump next || tmux send-keys M-l'

  # prompts
  bind -T root M-k run '$tmux_select -c bash $copycat_start "^λ.*" && $tmux_select -c bash $copycat_jump next || tmux send-keys M-k'

  # interesting things (URLs, emails, hashes, IPs)
  set -g @copycat_custom_search_emails '[-_\.[:alnum:]]+@[-_\.[:alnum:]]+'
  bind -T root M-i run '$tmux_select -c bash $copycat_start "($( tmux show-options -gv @copycat_search_C-u )|$( tmux show-options -gv @copycat_custom_search_emails )|$( tmux show-options -gv @copycat_search_M-h )|$( tmux show-options -gv @copycat_search_M-i ))" || tmux send-keys M-i'

# }}}

## powerline
# {{{

  if '[ -n "$SSH_CONNECTION" ]' 'run "tmux setenv -g TMUX_HOST_PROMPT \" $(hostname) \""' 'setenv -g TMUX_HOST_PROMPT ""'

  set -g status-left '#{?client_prefix,#[fg=colour254]#[bg=colour24]#[bold],#[fg=colour23]#[bg=colour159]#[bold]}#(tmux showenv -g TMUX_HOST_PROMPT | cut -d= -f2-)#{?client_prefix,#[fg=colour24],#[fg=colour159]}#[bg=colour236]'
  set -g status-right ''

  set -g status-style fg=colour231,bg=colour235
  set -g window-status-style fg=colour249
  set -g window-status-current-style default
  set -g window-status-last-style fg=colour31
  set -g window-status-format "#[default]  #[fg=colour240]#I  #[fg=colour244]#{?window_activity_flag,#[fg=colour11],}#W  "
  set -g window-status-current-format "#[fg=colour235,bg=colour31] #[fg=colour117,bg=colour31]#I  #[fg=colour231,bg=colour31,bold]#W #[fg=colour31,bg=colour235]"
  set -g window-status-separator " "

# }}}
