#!/bin/bash

# work around https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=790098
export GDK_SCALE=

emacs='/usr/bin/emacs --geometry 120x60'
message="Starting new server..."

case "$1" in
  -h|--help)
    exec /usr/bin/emacs --help
    ;;
  -v|--version)
    exec /usr/bin/emacs --version
    ;;
  -k|--kill)
    message="Stopping server..."
    exec emacsclient -e '(spacemacs/kill-emacs)'
    ;;
  -ns|--no-server)
    shift
    export EMACS_SERVER="disabled"
    message="Starting standalone session..."
    ;;
  *)
    if [ -S "/tmp/emacs$UID/server" ]; then
      message="Opening new frame..."
      emacs='emacsclient --create-frame'
      if [ $# -eq 0 ]; then
        emacs="$emacs --eval '(dotfiles/startup)'"
      fi
    elif [ -z "$DISPLAY" -o -n "$SSH_CONNECTION" ]; then
      unset DISPLAY
    fi
    ;;
esac

echo -e "\e[1;30m[$( basename ${emacs%% *} )]\e[0m $message"

if [ -n "$DISPLAY" ] && ! [[ "$*" =~ -nw|-t|--tty ]]; then
  eval exec $emacs "$@" &>/dev/null &
else
  eval exec $emacs "$@"
fi
