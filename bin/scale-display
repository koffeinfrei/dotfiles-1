#!/usr/bin/env ruby

require 'active_support/all'

# 3200x1800 - 1 x 1
# 1920x1200 - 2 x 2
# 1920x1080 - 2 x 1.8

def get_display(line)
  name = line.split(/\s/).last
  resolution = `xrandr | grep -FA1 '#{name} connected'`.lines.last
  width, height = resolution.scan(/(\d+)x(\d+)/).first

  {
    name: name,
    width: width.to_f,
    height: height.to_f,
  }
end

message = {}
displays = `xrandr --listactivemonitors`.lines.slice(1, 2)
int = get_display(displays.first)
int_settings = "--output #{int[:name]} --pos 0x0 --scale 1.1x1.1"

if displays.size == 1
  message[:title] = 'External display not connected'
  system "xrandr #{int_settings}"
else
  ext = get_display(displays.second)

  xscale = (ARGV[0] || 2.0) # (int[:width]  / ext[:width]  * 1.2)).to_f.round(2)
  yscale = (ARGV[1] || 2.0) # (int[:height] / ext[:height] * 1.2)).to_f.round(2)
  ypos = (ext[:height].to_i * yscale).round

  message[:title] = "External display #{ext[:name]}"
  message[:body] = "Resolution #{ext[:width]}x#{ext[:height]}, scaling to #{xscale}x#{yscale}"

  system "xrandr #{int_settings} --output #{ext[:name]} --pos 0x-#{ypos} --scale #{xscale}x#{yscale}"
end

system "notify-send -h int:transient:1 -i display '#{message[:title]}' '#{message[:body]}'"
